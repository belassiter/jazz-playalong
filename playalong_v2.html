<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jazz Progression Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Using a more modern font stack */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* Custom class for active chord highlighting */
        .active-chord {
            background-color: #3b82f6 !important; /* Tailwind's blue-500 */
            color: white !important;
            transform: scale(1.05);
            box-shadow: 0 4px 14px 0 rgb(0 118 255 / 39%);
        }
        
        /* Add cursor pointer to chord symbols */
        .progression-display span {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-8">

    <div class="container bg-white p-6 sm:p-8 rounded-xl shadow-lg text-center w-full max-w-2xl mx-4">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Jazz Progression Practice</h1>
        <p class="text-gray-500 mb-6">Select a key and progression type</p>

        <!-- Chord Display -->
        <div id="progression-container" class="progression-display grid grid-cols-4 gap-x-2 sm:gap-x-4 gap-y-2 mb-8 p-4 bg-gray-200 rounded-lg">
            <!-- Chords will be dynamically inserted here -->
        </div>

        <!-- Controls -->
        <div class="controls space-y-4">
            <div class="control-group grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Key Selection -->
                <div>
                    <label for="key-select" class="block text-sm font-medium text-gray-600 mb-1">Key</label>
                    <select id="key-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="C">C</option>
                        <option value="Db">D?</option>
                        <option value="D">D</option>
                        <option value="Eb">E?</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="Gb">G?</option>
                        <option value="G">G</option>
                        <option value="Ab">A?</option>
                        <option value="A">A</option>
                        <option value="Bb">B?</option>
                        <option value="B">B</option>
                    </select>
                </div>
                <!-- Progression Selection -->
                <div>
                    <label for="progression-select" class="block text-sm font-medium text-gray-600 mb-1">Chord Progression</label>
                    <select id="progression-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="major_ii_v_i">Major ii-V-I</option>
                        <option value="minor_ii_v_i">Minor ii-V-i</option>
                        <option value="blues">12-Bar Blues</option>
                    </select>
                </div>
                <!-- Tempo Control -->
                <div>
                    <label for="tempo-input" class="block text-sm font-medium text-gray-600 mb-1">Tempo (BPM)</label>
                    <input type="number" id="tempo-input" value="120" min="40" max="300" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            
            <!-- Instrument Selection -->
            <div>
                <label for="instrument-select" class="block text-sm font-medium text-gray-600 mb-1">Instrument</label>
                <select id="instrument-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="piano">Piano</option>
                    <option value="synth">Synth Sine</option>
                </select>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-1">
                <button id="play-btn" class="w-full py-3 px-4 bg-blue-600 text-white font-bold rounded-md hover:bg-blue-700 transition-colors duration-200 shadow-md">Play</button>
            </div>
        </div>
    </div>

    <!-- Tone.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script>
        // --- DATA ---
        const progressions = {
            major_ii_v_i: {
                'C': ['Dm7', 'G7', 'CMaj7'], 'Db': ['E?m7', 'A?7', 'D?Maj7'], 'D': ['Em7', 'A7', 'DMaj7'], 'Eb': ['Fm7', 'B?7', 'E?Maj7'], 'E': ['F?m7', 'B7', 'EMaj7'], 'F': ['Gm7', 'C7', 'FMaj7'], 'Gb': ['A?m7', 'D?7', 'G?Maj7'], 'G': ['Am7', 'D7', 'GMaj7'], 'Ab': ['B?m7', 'E?7', 'A?Maj7'], 'A': ['Bm7', 'E7', 'AMaj7'], 'Bb': ['Cm7', 'F7', 'B?Maj7'], 'B': ['C?m7', 'F?7', 'BMaj7']
            },
            minor_ii_v_i: {
                'C': ['Dø7', 'G7?9', 'CmM7'], 'Db': ['E?ø7', 'A?7?9', 'D?mM7'], 'D': ['Eø7', 'A7?9', 'DmM7'], 'Eb': ['Fø7', 'B?7?9', 'E?mM7'], 'E': ['F?ø7', 'B7?9', 'EmM7'], 'F': ['Gø7', 'C7?9', 'FmM7'], 'Gb': ['A?ø7', 'D?7?9', 'G?mM7'], 'G': ['Aø7', 'D7?9', 'GmM7'], 'Ab': ['B?ø7', 'E?7?9', 'A?mM7'], 'A': ['Bø7', 'E7?9', 'AmM7'], 'Bb': ['Cø7', 'F7?9', 'B?mM7'], 'B': ['C?ø7', 'F?7?9', 'BmM7']
            },
            blues: {
                'C': ['C7', 'F7', 'C7', 'C7', 'F7', 'F7', 'C7', 'A7', 'Dm7', 'G7', 'C7', 'G7'], 'Db': ['D?7', 'G?7', 'D?7', 'D?7', 'G?7', 'G?7', 'D?7', 'B?7', 'E?m7', 'A?7', 'D?7', 'A?7'], 'D': ['D7', 'G7', 'D7', 'D7', 'G7', 'G7', 'D7', 'B7', 'Em7', 'A7', 'D7', 'A7'], 'Eb': ['E?7', 'A?7', 'E?7', 'E?7', 'A?7', 'A?7', 'E?7', 'C7', 'Fm7', 'B?7', 'E?7', 'B?7'], 'E': ['E7', 'A7', 'E7', 'E7', 'A7', 'A7', 'E7', 'C?7', 'F?m7', 'B7', 'E7', 'B7'], 'F': ['F7', 'B?7', 'F7', 'F7', 'B?7', 'B?7', 'F7', 'D7', 'Gm7', 'C7', 'F7', 'C7'], 'Gb': ['G?7', 'B7', 'G?7', 'G?7', 'B7', 'B7', 'G?7', 'E?7', 'A?m7', 'D?7', 'G?7', 'D?7'], 'G': ['G7', 'C7', 'G7', 'G7', 'C7', 'C7', 'G7', 'E7', 'Am7', 'D7', 'G7', 'D7'], 'Ab': ['A?7', 'D?7', 'A?7', 'A?7', 'D?7', 'D?7', 'A?7', 'F7', 'B?m7', 'E?7', 'A?7', 'E?7'], 'A': ['A7', 'D7', 'A7', 'A7', 'D7', 'D7', 'A7', 'F?7', 'Bm7', 'E7', 'A7', 'E7'], 'Bb': ['B?7', 'E?7', 'B?7', 'B?7', 'E?7', 'E?7', 'B?7', 'G7', 'Cm7', 'F7', 'B?7', 'F7'], 'B': ['B7', 'E7', 'B7', 'B7', 'E7', 'E7', 'B7', 'G?7', 'C?m7', 'F?7', 'B7', 'F?7']
            }
        };

        const chordNotes = {}; // For bassline
        const compingChordNotes = {}; // For harmony

        const dom = { keySelect: document.getElementById('key-select'), progressionSelect: document.getElementById('progression-select'), tempoInput: document.getElementById('tempo-input'), instrumentSelect: document.getElementById('instrument-select'), playBtn: document.getElementById('play-btn'), progressionContainer: document.getElementById('progression-container') };
        
        let harmonyInstrument, bassInstrument, bassPart, harmonyPart, visualsLoop, isPlaying = false, currentProgressionChords = [];
        const piano = new Tone.Sampler({ urls: { 'A2': 'A2.mp3', 'C3': 'C3.mp3', 'D#3': 'Ds3.mp3', 'F#3': 'Fs3.mp3', 'A3': 'A3.mp3', 'C4': 'C4.mp3', 'D#4': 'Ds4.mp3', 'F#4': 'Fs4.mp3' }, release: 1, baseUrl: 'https://tonejs.github.io/audio/salamander/', volume: -10 }).toDestination();
        const synth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'fmsine' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.3, release: 1 }, volume: -18 }).toDestination();
        const bassPiano = new Tone.Sampler({ urls: { 'A2': 'A2.mp3', 'C3': 'C3.mp3', 'D#3': 'Ds3.mp3', 'F#3': 'Fs3.mp3' }, release: 1, baseUrl: 'https://tonejs.github.io/audio/salamander/', volume: -2 }).toDestination();

        function setInstrument(instrumentName) {
            if (instrumentName === 'piano') {
                if (!piano.loaded || !bassPiano.loaded) { dom.playBtn.disabled = true; dom.playBtn.textContent = 'Loading...'; }
                harmonyInstrument = piano;
                bassInstrument = bassPiano;
            } else { 
                harmonyInstrument = synth;
                bassInstrument = new Tone.MonoSynth({ oscillator: { type: "fmsine" }, envelope: { attack: 0.05, decay: 0.3, sustain: 0.4, release: 1.4 }, volume: -4 }).toDestination();
            }
        }
        
        async function ensureAudioContext() { if (Tone.context.state !== 'running') await Tone.start(); }

        function getChordTones(chordSymbol) {
            const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
            const noteNormalization = { "D?": "C#", "E?": "D#", "G?": "F#", "A?": "G#", "B?": "A#" };
            
            const rootMatch = chordSymbol.match(/^[A-G][??]?/);
            if (!rootMatch) return null;

            let rootName = rootMatch[0].replace('?', '#').replace('?', 'b');
            if (rootName.includes('b')) {
                 const normalizedKey = rootName.charAt(0) + '?';
                 if(noteNormalization[normalizedKey]) {
                     rootName = noteNormalization[normalizedKey];
                 }
            }
            
            const rootIndex = noteNames.indexOf(rootName);
            if (rootIndex === -1) return null;
            
            let thirdInterval, fifthInterval, seventhInterval = 10, ninthInterval = 14;
            
            if (chordSymbol.includes('Maj7') || chordSymbol.includes('mM7')) {
                seventhInterval = 11;
            }

            if (chordSymbol.includes('m') || chordSymbol.includes('ø')) {
                thirdInterval = 3;
            } else {
                thirdInterval = 4;
            }

            if (chordSymbol.includes('ø')) {
                fifthInterval = 6;
            } else {
                fifthInterval = 7;
            }
            
            if (chordSymbol.includes('?9')) {
                ninthInterval = 13;
            }

            const thirdName = noteNames[(rootIndex + thirdInterval) % 12];
            const fifthName = noteNames[(rootIndex + fifthInterval) % 12];
            const seventhName = noteNames[(rootIndex + seventhInterval) % 12];
            const ninthName = noteNames[(rootIndex + ninthInterval) % 12];

            return { root: rootName, third: thirdName, fifth: fifthName, seventh: seventhName, ninth: ninthName };
        }

        function generateWalkingBassline(chords) {
            const bassEvents = [];
            const approachTechniques = ['half_step_below', 'half_step_above', 'fifth_above', 'fourth_below', 'whole_step_above'];

            for (let i = 0; i < chords.length; i++) {
                const chordSymbol = chords[i];
                const nextChordSymbol = chords[(i + 1) % chords.length];
                const voicing = chordNotes[chordSymbol];
                if (!voicing) continue;

                const lineNotes = [];
                
                const root = voicing[0][0];
                const third = voicing[0][1];
                const fifth = voicing[0][2];
                const seventh = voicing[0][3];

                const bassRoot = Tone.Frequency(root).toFrequency() < 150 ? root : Tone.Frequency(root).transpose(-12).toNote();
                lineNotes.push(bassRoot);

                let beat2Note = Tone.Frequency(third).toFrequency() < 150 ? third : Tone.Frequency(third).transpose(-12).toNote();
                if (beat2Note === lineNotes[0]) {
                    beat2Note = Tone.Frequency(fifth).toFrequency() < 150 ? fifth : Tone.Frequency(fifth).transpose(-12).toNote();
                }
                lineNotes.push(beat2Note);

                let beat3Note = Tone.Frequency(fifth).toFrequency() < 150 ? fifth : Tone.Frequency(fifth).transpose(-12).toNote();
                if (beat3Note === lineNotes[1]) {
                    beat3Note = Tone.Frequency(seventh).toFrequency() < 150 ? seventh : Tone.Frequency(seventh).transpose(-12).toNote();
                }
                lineNotes.push(beat3Note);

                const nextVoicing = chordNotes[nextChordSymbol];
                const nextRoot = nextVoicing ? nextVoicing[0][0] : root;
                const bassNextRoot = Tone.Frequency(nextRoot).toFrequency() < 150 ? nextRoot : Tone.Frequency(nextRoot).transpose(-12).toNote();
                
                let approachNote;
                if (chordSymbol === nextChordSymbol) {
                    approachNote = Tone.Frequency(seventh).toFrequency() < 150 ? seventh : Tone.Frequency(seventh).transpose(-12).toNote();
                    if (approachNote === lineNotes[2]) {
                        approachNote = bassRoot;
                    }
                } else {
                    let attempts = 0;
                    do {
                        const randomTechnique = approachTechniques[Math.floor(Math.random() * approachTechniques.length)];
                        switch (randomTechnique) {
                            case 'half_step_above': approachNote = Tone.Frequency(bassNextRoot).transpose(1).toNote(); break;
                            case 'whole_step_above': approachNote = Tone.Frequency(bassNextRoot).transpose(2).toNote(); break;
                            case 'fifth_above': approachNote = Tone.Frequency(bassNextRoot).transpose(7).toNote(); break;
                            case 'fourth_below': approachNote = Tone.Frequency(bassNextRoot).transpose(-5).toNote(); break;
                            default: approachNote = Tone.Frequency(bassNextRoot).transpose(-1).toNote(); break;
                        }
                        attempts++;
                    } while (approachNote === lineNotes[2] && attempts < 5);
                }
                lineNotes.push(approachNote);

                bassEvents.push({ time: `${i}:0`, note: lineNotes[0], duration: '4n' });
                bassEvents.push({ time: `${i}:1`, note: lineNotes[1], duration: '4n' });
                bassEvents.push({ time: `${i}:2`, note: lineNotes[2], duration: '4n' });
                bassEvents.push({ time: `${i}:3`, note: lineNotes[3], duration: '4n' });
            }
            return bassEvents;
        }

        function generateProgression() {
            if (isPlaying) {
                togglePlayback();
            }
            
            [bassPart, harmonyPart, visualsLoop].forEach(part => {
                if (part) part.dispose();
            });

            let chords = progressions[dom.progressionSelect.value][dom.keySelect.value];
            if (dom.progressionSelect.value.includes('ii_v_i')) {
                chords = [...chords, chords[chords.length - 1]];
            }
            currentProgressionChords = chords;
            
            dom.progressionContainer.innerHTML = '';
            currentProgressionChords.forEach((chord, index) => {
                const chordEl = document.createElement('span');
                chordEl.innerHTML = chord.replace('b', '?').replace('#', '?');
                chordEl.className = 'chord-display-item font-bold text-xl sm:text-2xl text-gray-700 p-3 sm:p-4 rounded-md transition-all duration-200 ease-in-out flex items-center justify-center';
                if ((index + 1) % 4 !== 0 && index < currentProgressionChords.length - 1) chordEl.classList.add('border-r-2', 'border-gray-300');
                dom.progressionContainer.appendChild(chordEl);
                
                chordEl.addEventListener('click', async () => {
                    await ensureAudioContext();
                    if (harmonyInstrument.loaded === false) return;
                    const voicing = chordNotes[chord];
                    if (!voicing) { console.error(`Voicing not found for chord: ${chord}`); return; }
                    harmonyInstrument.releaseAll();
                    harmonyInstrument.triggerAttackRelease(voicing[0], '1n');
                });
            });

            const bassEvents = generateWalkingBassline(currentProgressionChords);
            
            const rhythmicPatterns = [
                [{ time: "0:0:2", duration: "8n" }, { time: "0:2:0", duration: "4n" }],
                [{ time: "0:1:2", duration: "8n" }, { time: "0:3:0", duration: "4n" }],
                [{ time: "0:1:0", duration: "4n" }, { time: "0:2:2", duration: "8n" }],
                [{ time: "0:2:2", duration: "4n." }],
                [{ time: "0:0:0", duration: "4n." }, { time: "0:1:2", duration: "8n" }]
            ];

            const harmonyEvents = [];
            currentProgressionChords.forEach((chord, i) => {
                const voicing = compingChordNotes[chord];
                if (!voicing) return;
                const pattern = rhythmicPatterns[Math.floor(Math.random() * rhythmicPatterns.length)];
                pattern.forEach(p => {
                    const eventTime = Tone.Time(`${i}m`) + Tone.Time(p.time);
                    harmonyEvents.push({ time: eventTime, note: voicing[0], duration: p.duration });
                });
            });
            
            bassPart = new Tone.Part((time, value) => { bassInstrument.triggerAttackRelease(value.note, value.duration, time); }, bassEvents);
            harmonyPart = new Tone.Part((time, value) => { harmonyInstrument.triggerAttackRelease(value.note, value.duration, time); }, harmonyEvents);
            visualsLoop = new Tone.Loop(time => {
                Tone.Draw.schedule(() => {
                    const measure = Math.floor(Tone.Transport.position.split(':')[0]);
                    document.querySelectorAll('.chord-display-item').forEach((disp, index) => disp.classList.toggle('active-chord', index === measure % currentProgressionChords.length));
                }, time);
            }, '1m');

            const loopEnd = `${currentProgressionChords.length}m`;
            [bassPart, harmonyPart, visualsLoop].forEach(part => {
                part.loopEnd = loopEnd;
                part.loop = true;
            });
        }

        async function togglePlayback() {
            await ensureAudioContext();
            if (Tone.Transport.state === 'started') {
                Tone.Transport.stop();
                harmonyInstrument.releaseAll();
                if (bassInstrument.releaseAll) bassInstrument.releaseAll();
                else bassInstrument.triggerRelease();
                isPlaying = false;
                
                dom.playBtn.textContent = 'Play';
                dom.playBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                dom.playBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                document.querySelectorAll('.chord-display-item').forEach(d => d.classList.remove('active-chord'));
            } else {
                if (harmonyInstrument.loaded === false) return;
                
                Tone.Transport.swing = 0.75;
                Tone.Transport.swingSubdivision = '8n';

                Tone.Transport.bpm.value = parseInt(dom.tempoInput.value, 10);
                bassPart.start(0);
                harmonyPart.start(0);
                visualsLoop.start(0);
                Tone.Transport.start();
                console.log("Test PASSED: Starting playback.");
                isPlaying = true;
                dom.playBtn.textContent = 'Stop';
                dom.playBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                dom.playBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            }
        }

        function generateCompleteChordDictionaries() {
            const allChords = new Set();
            for (const progressionType in progressions) {
                for (const key in progressions[progressionType]) {
                    progressions[progressionType][key].forEach(chord => allChords.add(chord));
                }
            }

            allChords.forEach(chordSymbol => {
                const tones = getChordTones(chordSymbol);
                if (tones) {
                    let root = `${tones.root}2`;
                    let third = `${tones.third}3`;
                    let fifth = `${tones.fifth}3`;
                    let seventh = `${tones.seventh}3`;
                    if (Tone.Frequency(third).toMidi() < Tone.Frequency(root).toMidi() + 12) third = `${tones.third}4`;
                    if (Tone.Frequency(fifth).toMidi() < Tone.Frequency(third).toMidi()) fifth = `${tones.fifth}4`;
                    if (Tone.Frequency(seventh).toMidi() < Tone.Frequency(fifth).toMidi()) seventh = `${tones.seventh}4`;
                    chordNotes[chordSymbol] = [[root, third, fifth, seventh]];
                    
                    let compThird = `${tones.third}3`;
                    let compFifth = `${tones.fifth}3`;
                    let compSeventh = `${tones.seventh}3`;
                    let compNinth = `${tones.ninth}4`;
                    if (Tone.Frequency(compFifth).toMidi() < Tone.Frequency(compThird).toMidi()) compFifth = `${tones.fifth}4`;
                    if (Tone.Frequency(compSeventh).toMidi() < Tone.Frequency(compFifth).toMidi()) compSeventh = `${tones.seventh}4`;
                    if (Tone.Frequency(compNinth).toMidi() < Tone.Frequency(compSeventh).toMidi()) compNinth = `${tones.ninth}5`;
                    compingChordNotes[chordSymbol] = [[compThird, compFifth, compSeventh, compNinth]];
                }
            });
        }

        dom.keySelect.addEventListener('change', generateProgression);
        dom.progressionSelect.addEventListener('change', generateProgression);
        dom.playBtn.addEventListener('click', togglePlayback);
        dom.tempoInput.addEventListener('input', e => { if (!isNaN(e.target.value) && e.target.value > 0) Tone.Transport.bpm.value = e.target.value; });
        dom.instrumentSelect.addEventListener('change', e => setInstrument(e.target.value));

        window.onload = () => {
            generateCompleteChordDictionaries();
            setInstrument(dom.instrumentSelect.value);
            generateProgression();
            Tone.loaded().then(() => {
                dom.playBtn.disabled = false;
                if (!isPlaying) dom.playBtn.textContent = 'Play';
            });
        };
    </script>
</body>
</html>
